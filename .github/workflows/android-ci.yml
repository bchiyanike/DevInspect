name: Device Inspector APK Build

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        default: 'main'
        required: true
        type: string
      build-type:
        description: 'Build type (debug or release)'
        default: 'debug'
        required: true
        type: choice
        options:
          - debug
          - release

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'zulu'
          cache: 'gradle'

      - name: Setup Android SDK (JDK 8 compatible)
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 8.0
          accept-android-sdk-licenses: true
          packages: platform-tools, tools

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Get branch name for filename
        id: branch-info
        run: |
          BRANCH_NAME=$(echo ${GITHUB_REF#refs/heads/} | tr '/' '-' | tr '[:upper:]' '[:lower:]' | cut -c1-50)
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "Building from branch: $BRANCH_NAME"

      - name: Build APK
        run: ./gradlew assemble${{ inputs.build-type }} --stacktrace

      - name: Rename APKs with branch name
        run: |
          BUILD_TYPE="${{ inputs.build-type }}"
          BRANCH_NAME="${{ steps.branch-info.outputs.branch_name }}"

          for apk_file in app/build/outputs/apk/$BUILD_TYPE/*.apk; do
            if [ -f "$apk_file" ]; then
              filename=$(basename "$apk_file")
              new_filename="${filename%.apk}-$BRANCH_NAME.apk"
              mv "$apk_file" "app/build/outputs/apk/$BUILD_TYPE/$new_filename"
              echo "Renamed: $filename â†’ $new_filename"
            fi
          done

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ inputs.build-type }}-${{ steps.branch-info.outputs.branch_name }}
          path: |
            app/build/outputs/apk/${{ inputs.build-type }}/*.apk
          retention-days: 7

      - name: Show build info
        run: |
          echo "Build completed successfully!"
          echo "Branch: ${{ inputs.branch }}"
          echo "Build type: ${{ inputs.build-type }}"
          ls -la app/build/outputs/apk/${{ inputs.build-type }}/*.apk
          du -h app/build/outputs/apk/${{ inputs.build-type }}/*.apk